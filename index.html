<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿éšªçŸ¥è­˜ç‹ - å°¾ç‰™å¤§äº‚é¬¥</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
            color: #ffffff; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
            overflow-x: hidden; 
            touch-action: manipulation;
        }
        .btn-push { transition: all 0.1s; transform: translateY(0); } 
        .btn-push:active:not(:disabled) { transform: translateY(4px); filter: brightness(90%); }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); transform: none !important; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-pulse-fast { animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .neon-text { text-shadow: 0 0 15px rgba(255, 255, 255, 0.6); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // 1. ç³»çµ±è¨­å®š
        // ==========================================
        const FIREBASE_CONFIG = {
            projectId: "cathaylife-e0714", 
            apiKey: "AIzaSyDoeEnc5-cebY6RfWAYnGM5y1BwLHFG5_g"    
        };

        const SOUNDS = {
            lobby: "https://assets.mixkit.co/active_storage/sfx/255/255-preview.mp3",
            game: "https://assets.mixkit.co/active_storage/sfx/896/896-preview.mp3",
            correct: "https://www.myinstants.com/media/sounds/super-mario-coin.mp3",
            victory: "https://www.myinstants.com/media/sounds/final-fantasy-v-music-victory-fanfare.mp3"
        };

        const QUESTIONS = [
            { q: "é‡å°ç”·æ€§èˆ‡å¥³æ€§å®¹æ˜“ç™¼ç”Ÿçš„ç‰¹å®šç™Œç—‡ï¼Œå“ªä¸€å°ã€Œæƒ…ä¾¶æª”ã€å•†å“å¯åŠ ç¢¼çµ¦ä»˜ 50%ï¼Ÿ", opts: ["(A) ç¾…å¯†æ­ èˆ‡ èŒ±éº—è‘‰", "(B) è±ªåº·æ„›(ç”·) èˆ‡ å¥½åº·æ„›(å¥³)", "(C) çœŸå¿ƒå®‰ èˆ‡ çœŸå®‰å®‰", "(D) å¤§é™¸æ–°å¨˜ èˆ‡ å°ç£éƒ"], ans: 1, note: "é‡å°ç‰¹å®šæ€§åˆ¥ç™Œç—‡ï¼Œç¬¬6å¹´å¾Œæœ€é«˜é¡å¤–çµ¦ä»˜ 50%ã€‚" },
            { q: "å“ªä¸€å¼µç¾å…ƒä¿å–®ï¼Œåå­—è½èµ·ä¾†ã€Œå¥åº·åˆè³ºéŒ¢ã€ï¼Œä¸”å…¼é¡§ã€Œç™Œç—‡(é‡åº¦)æå‰çµ¦ä»˜ã€ï¼Ÿ", opts: ["(A) ç¾æ„›åº·ç›ˆ", "(B) ç¾åˆ©ç››è®š", "(C) ç¾æ»¿é›™å¯¶", "(D) ç¾éº—äººç”Ÿ"], ans: 0, note: "ã€Œç¾æ„›åº·ç›ˆã€åˆ©è®Šå‹ + ç™Œç—‡æå‰çµ¦ä»˜ï¼Œå…¼é¡§è²¡å¯Œèˆ‡å¥åº·ã€‚" },
            { q: "é‡å°é«˜é½¡æ—ç¾¤(55-75æ­²)ï¼Œåªè¦æ´»åˆ°91æ­²å°±èƒ½é ˜å›ä¸€åŠä¿è²»çš„æ„å¤–éšªæ˜¯ï¼Ÿ", opts: ["(A) æ¨‚äº«å¹³å®‰", "(B) é ¤é¤Šå¤©å¹´", "(C) é•·å‘½ç™¾æ­²", "(D) ç¦å¦‚æ±æµ·"], ans: 0, note: "ã€Œæ¨‚äº«å¹³å®‰ã€é‡å°é«˜é½¡è¨­è¨ˆï¼Œ91æ­²ä»ç”Ÿå­˜çµ¦ä»˜ç¸½ä¿è²» 50%ã€‚" },
            { q: "ä¿éšªæ¥­å‹™å“¡æœ€å²å®³çš„è¶…èƒ½åŠ›æ˜¯ä»€éº¼ï¼Ÿ", opts: ["(A) éš±å½¢", "(B) ä»»ä½•è©±é¡Œéƒ½èƒ½èŠåˆ°ä¿éšª", "(C) é£›è¡Œ", "(D) å¥½è…°åŠ›"], ans: 1, note: "é€™å°±æ˜¯å°ˆæ¥­ï¼éš¨æ™‚éš¨åœ°æ•£æ’­æ„›çš„ç¨®å­ï¼" },
            { q: "é‡åˆ°ã€Œå¥§å®¢ã€çš„æ™‚å€™ï¼Œå¿ƒè£¡è¦é»˜å¿µä»€éº¼å’’èªï¼Ÿ", opts: ["(A) åŠ ä¸Šå»ï¼çµ¦ä»–æ­»ï¼", "(B) è«ç”Ÿæ°£ï¼Œæ°£å‡ºç—…ä¾†ç„¡äººæ›¿", "(C) èˆ¬è‹¥æ³¢ç¾…èœœ", "(D) æ€¥æ€¥å¦‚å¾‹ä»¤"], ans: 1, note: "æˆ–æ˜¯é»˜å¿µï¼šã€Œä¸‹ä¸€ä½æœƒæ›´å¥½ï¼ã€ä¿æŒæ­£èƒ½é‡ã€‚" },
            { q: "å®œè˜­å¤šé›¨è·¯æ»‘ï¼Œé¨æ©Ÿè»Šæ€•çŠç”°ã€‚å“ªå¼µé™„ç´„æ˜¯ã€Œéª¨æŠ˜æ•‘æ˜Ÿã€ï¼Œé€£è„«è‡¼éƒ½è³ ï¼Ÿ", opts: ["(A) å‹å‹‡å¥", "(B) æ–°é‡‘éª¨åŠ›", "(C) éµç‰›é‹åŠŸæ•£", "(D) çœŸçš„å¥½ç—›"], ans: 1, note: "ã€Œæ–°é‡‘éª¨åŠ›ã€é‡å°éª¨æŠ˜ã€è„«è‡¼æœ‰ç‰¹åˆ¥ä¿éšœï¼Œæ©Ÿè»Šæ—å¿…å‚™ã€‚" },
            { q: "ã€è…¦ç­‹æ€¥è½‰å½ã€‘ä¸€éš»å…¬é›ååœ¨å±‹é ‚ä¸Šï¼Œè«‹å•ç‰ ä¸‹çš„è›‹æœƒå¾€å“ªé‚Šæ‰ï¼Ÿ", opts: ["(A) å·¦é‚Š", "(B) å³é‚Š", "(C) å±‹é ‚ä¸­é–“", "(D) å…¬é›ä¸æœƒä¸‹è›‹"], ans: 3, note: "ç¶“å…¸é™·é˜±é¡Œï¼å…¬é›æ˜¯ä¸æœƒä¸‹è›‹çš„ï¼" },
            { q: "ã€è…¦ç­‹æ€¥è½‰å½ã€‘å“ªä¸€å€‹å¡é€šäººç‰©æœ€å–œæ­¡å¹«åŠ©åˆ¥äººï¼Ÿ", opts: ["(A) å“†å•¦Aå¤¢", "(B) å·§è™", "(C) ä½©ä½©è±¬", "(D) éºµåŒ…è¶…äºº"], ans: 1, note: "å› ç‚ºã€Œå·§è™ã€æ•‘æ´ (å‰›å¥½æ•‘äºº)ï¼å°èªè«§éŸ³æ¢—ï¼" },
            { q: "å®œè˜­äººå£é ­ç¦ªï¼Œå½¢å®¹æ±è¥¿ã€Œå¾ˆæ£’ã€å¾ˆå¼·ã€æœƒèªªï¼Ÿ", opts: ["(A) æ°´å•¦", "(B) å‹ (Kå‹)", "(C) ç‹‚", "(D) é ‚"], ans: 1, note: "å®œè˜­äººæ‰æ‡‚ï¼å‹å¥½å‘·ï¼å‹å²å®³ï¼" },
            { q: "å®œè˜­é„‰è¦ªæƒ³æŠŠéŒ¢çœä¸‹ä¾†é¤Šè€ï¼Œå“ªå¼µé˜²ç™Œéšªã€Œ30å¹´æ²’ç†è³ ã€å¯æ‹¿å›éŒ¢ï¼Ÿ", opts: ["(A) æ»¿æº¢åº·æ„›", "(B) æ»¿æ‰‹ç¾é‡‘", "(C) æº¢èµ·å»ç©", "(D) åº·åº·èˆ"], ans: 0, note: "ã€Œæ»¿æº¢åº·æ„›ã€æ²’ç”¨åˆ°é‚„èƒ½æ‹¿å›ä¾†ï¼Œç²¾æ‰“ç´°ç®—é¦–é¸ã€‚" }
        ];

        function App() {
            const [view, setView] = useState('role-select'); 
            const [db, setDb] = useState(null);
            const [roomCode, setRoomCode] = useState('');
            const [gameState, setGameState] = useState({});
            const [myPlayer, setMyPlayer] = useState({ name: '', score: 0 });
            const [players, setPlayers] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [timer, setTimer] = useState(15); 
            const revealedRef = useRef(false);

            const [isMuted, setIsMuted] = useState(false);
            const audioRef = useRef({
                lobby: new Audio(SOUNDS.lobby),
                game: new Audio(SOUNDS.game),
                correct: new Audio(SOUNDS.correct),
                victory: new Audio(SOUNDS.victory)
            });

            useEffect(() => {
                audioRef.current.lobby.loop = true;
                audioRef.current.lobby.volume = 0.4;
                audioRef.current.game.loop = true;
                audioRef.current.game.volume = 0.3;

                if (!firebase.apps.length) {
                    try {
                        firebase.initializeApp({
                            apiKey: FIREBASE_CONFIG.apiKey,
                            authDomain: `${FIREBASE_CONFIG.projectId}.firebaseapp.com`,
                            projectId: FIREBASE_CONFIG.projectId
                        });
                        setDb(firebase.firestore());
                    } catch (error) { alert("é€£ç·šéŒ¯èª¤"); }
                } else { setDb(firebase.firestore()); }

                const savedRoom = sessionStorage.getItem('host_room_code');
                if (savedRoom) setRoomCode(savedRoom);
            }, []);

            // ğŸµ éŸ³æ¨‚é‚è¼¯ (åš´æ ¼é™åˆ¶ï¼šé Host çµ•å°ä¸æ’­)
            useEffect(() => {
                // å¦‚æœæ˜¯æˆå“¡ (view !== 'host')ï¼Œå¼·åˆ¶æš«åœæ‰€æœ‰éŸ³æ¨‚
                if (isMuted || view !== 'host') {
                    audioRef.current.lobby.pause();
                    audioRef.current.game.pause();
                    return;
                }
                
                // ä»¥ä¸‹åªæœ‰ä¸»æŒäººæœƒåŸ·è¡Œ
                audioRef.current.lobby.pause();
                audioRef.current.game.pause();

                if (gameState.step === 'lobby') audioRef.current.lobby.play().catch(e=>{});
                else if (['question', 'reveal', 'leaderboard'].includes(gameState.step)) audioRef.current.game.play().catch(e=>{});
            }, [gameState.step, view, isMuted]);

            const playSound = (type) => {
                // é›™é‡æª¢æŸ¥ï¼šé Host ä¸å‡†æ’­
                if (isMuted || view !== 'host') return;
                const sound = audioRef.current[type];
                if (sound) { sound.currentTime = 0; sound.play().catch(e => {}); }
            };

            const toggleMute = () => {
                // å†æ¬¡æª¢æŸ¥ï¼šé Host ä¸å‡†æ“ä½œ
                if (view !== 'host') return;

                if (isMuted) {
                    setIsMuted(false);
                    if (gameState.step === 'lobby') audioRef.current.lobby.play().catch(e=>{});
                    else if (['question', 'reveal', 'leaderboard'].includes(gameState.step)) audioRef.current.game.play().catch(e=>{});
                } else {
                    setIsMuted(true);
                    audioRef.current.lobby.pause();
                    audioRef.current.game.pause();
                }
            };

            // é‡ç½®è¨ˆæ™‚å™¨
            useEffect(() => {
                if (gameState.step === 'question') {
                    setTimer(15);
                    revealedRef.current = false;
                }
            }, [gameState.qIndex, gameState.step]);

            // è¨ˆæ™‚èˆ‡è‡ªå‹•å…¬ä½ˆ
            useEffect(() => {
                let interval;
                if (view === 'host' && gameState.step === 'question' && !revealedRef.current) {
                    if (timer > 0) {
                        interval = setInterval(() => setTimer(t => t - 1), 1000);
                    } else if (timer === 0 && !isProcessing) {
                        revealedRef.current = true;
                        hostAction('reveal');
                    }
                    if (players.length > 0) {
                        const answeredCount = players.filter(p => p.lastQ === gameState.qIndex).length;
                        if (answeredCount === players.length && answeredCount > 0 && !isProcessing) {
                            revealedRef.current = true;
                            setTimeout(() => hostAction('reveal'), 800);
                        }
                    }
                }
                return () => clearInterval(interval);
            }, [view, gameState.step, timer, players, isProcessing]);

            const sortPlayers = (list) => {
                return list.sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.name.localeCompare(b.name);
                });
            };

            // --- Host Functions ---
            const initHost = async () => {
                if(!db) return;
                const savedRoom = sessionStorage.getItem('host_room_code');
                if (savedRoom) {
                    const doc = await db.collection('rooms').doc(savedRoom).get();
                    if (doc.exists) {
                        setRoomCode(savedRoom);
                        startHostListeners(savedRoom);
                        return;
                    }
                }
                createRoom();
            };

            const createRoom = async () => {
                const code = Math.floor(1000 + Math.random() * 9000).toString();
                setRoomCode(code);
                sessionStorage.setItem('host_room_code', code);
                await db.collection('rooms').doc(code).set({
                    step: 'lobby', qIndex: 0, showAnswer: false, 
                    startTime: 0, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                startHostListeners(code);
            };

            const startHostListeners = (code) => {
                db.collection('rooms').doc(code).onSnapshot(doc => setGameState(doc.data()));
                db.collection('rooms').doc(code).collection('players').onSnapshot(snap => {
                    const list = []; 
                    snap.forEach(d => list.push({id: d.id, ...d.data()}));
                    setPlayers(sortPlayers(list));
                });
                setView('host');
            };

            const hostAction = async (action) => {
                if(!db || isProcessing) return;
                
                if (action === 'reveal' && gameState.step === 'reveal') return;
                if (action === 'start' && gameState.step === 'question') return;

                setIsProcessing(true);

                try {
                    const ref = db.collection('rooms').doc(roomCode);
                    
                    if (action === 'reveal') {
                        playSound('correct');
                        await ref.update({ showAnswer: true, step: 'reveal' });
                    }
                    else if (action === 'end') {
                        playSound('victory');
                    }
                    else if (action === 'start') {
                        setTimer(15);
                        await ref.update({ step: 'question', qIndex: 0, showAnswer: false, startTime: Date.now() });
                    }
                    else if (action === 'nextQ') {
                        const nextIdx = gameState.qIndex + 1;
                        if (nextIdx >= QUESTIONS.length) { 
                            playSound('victory'); await ref.update({ step: 'end' }); 
                        } else { 
                            setTimer(15);
                            await ref.update({ step: 'question', qIndex: nextIdx, showAnswer: false, startTime: Date.now() }); 
                        }
                    } else if (action === 'leaderboard') {
                        await ref.update({ step: 'leaderboard' });
                    }
                } catch (e) {
                    console.error("Action Failed:", e);
                } finally {
                    setTimeout(() => setIsProcessing(false), 1000);
                }
            };

            // --- Player Functions ---
            const joinRoom = async () => {
                if(!db) return alert("é€£ç·šä¸­...");
                if(!roomCode || !myPlayer.name) return alert("è«‹è¼¸å…¥æˆ¿é–“è™Ÿèˆ‡æš±ç¨±");
                
                const roomRef = db.collection('rooms').doc(roomCode);
                try {
                    const doc = await roomRef.get();
                    if(!doc.exists) return alert("æˆ¿é–“ä¸å­˜åœ¨");
                    
                    const uid = Math.random().toString(36).substr(2, 9);
                    await roomRef.collection('players').doc(uid).set({ name: myPlayer.name, score: 0, lastQ: -1 });
                    setMyPlayer({...myPlayer, uid});
                    
                    roomRef.onSnapshot(doc => setGameState(doc.data()));
                    roomRef.collection('players').doc(uid).onSnapshot(doc => { if(doc.exists) setMyPlayer(p => ({...p, ...doc.data()})); });
                    roomRef.collection('players').onSnapshot(snap => {
                        const list = []; snap.forEach(d => list.push({id: d.id, ...d.data()}));
                        setPlayers(sortPlayers(list));
                    });
                    setView('player');
                } catch (e) { alert("é€£ç·šå¤±æ•—"); }
            };

            const playerAnswer = async (optIndex) => {
                if (gameState.step !== 'question' || gameState.qIndex === myPlayer.lastQ) return;
                
                const currentQ = QUESTIONS[gameState.qIndex];
                const isCorrect = optIndex === currentQ.ans;
                let points = 0;

                if (isCorrect) {
                    const now = Date.now();
                    const start = gameState.startTime || now;
                    const elapsedSec = (now - start) / 1000;
                    points = Math.max(200, Math.round(1000 - (elapsedSec * 30)));
                }
                
                const roomRef = db.collection('rooms').doc(roomCode);
                setMyPlayer(p => ({...p, lastQ: gameState.qIndex}));
                
                try {
                    await roomRef.collection('players').doc(myPlayer.uid).update({
                        score: firebase.firestore.FieldValue.increment(points), lastQ: gameState.qIndex
                    });
                } catch(e) { console.error("Answer failed"); }
            };

            // ğŸ”‡ éŸ³æ•ˆæŒ‰éˆ• (åªé¡¯ç¤ºçµ¦ä¸»æŒäººï¼)
            const SoundToggle = () => {
                if (view !== 'host') return null; // æˆå“¡ç«¯å®Œå…¨ä¸æ¸²æŸ“æ­¤æŒ‰éˆ•
                return (
                    <button onClick={toggleMute} className="fixed top-4 right-4 z-50 bg-gray-700/80 border-2 border-white/30 text-white p-4 rounded-full shadow-lg backdrop-blur-md transition text-2xl w-16 h-16 flex items-center justify-center">
                        {isMuted ? "ğŸ”‡" : "ğŸ”Š"}
                    </button>
                );
            };

            // 1. Role Select
            if (view === 'role-select') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 space-y-12">
                    <h1 className="text-6xl md:text-8xl font-black mb-8 text-center text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-pink-500 drop-shadow-lg neon-text tracking-widest leading-tight">ä¿éšª<br/>çŸ¥è­˜ç‹</h1>
                    <div className="flex flex-col gap-8 w-full max-w-xl justify-center">
                        <button onClick={initHost} className="bg-purple-700/80 hover:bg-purple-600 w-full py-6 rounded-3xl text-3xl font-bold btn-push shadow-2xl border-2 border-purple-400/50 text-white flex justify-center items-center gap-4 backdrop-blur-sm"><span>ğŸ“º</span> æˆ‘æ˜¯ä¸»æŒäºº</button>
                        <div className="bg-gray-800/90 w-full p-8 rounded-3xl flex flex-col justify-center space-y-6 border-2 border-gray-600 shadow-2xl backdrop-blur-md">
                            <div className="text-center font-bold text-4xl mb-2 text-yellow-400">ğŸ“± æˆ‘æ˜¯åƒè³½è€…</div>
                            <input placeholder="è¼¸å…¥æˆ¿é–“è™Ÿ" className="w-full p-6 bg-gray-900 rounded-2xl text-center text-4xl font-bold outline-none text-white border-2 border-gray-600 focus:border-green-500 placeholder-gray-600" value={roomCode} onChange={e=>setRoomCode(e.target.value)} type="tel"/>
                            <input placeholder="è¼¸å…¥ä½ çš„åå­—" className="w-full p-6 bg-gray-900 rounded-2xl text-center text-4xl font-bold outline-none text-white border-2 border-gray-600 focus:border-green-500 placeholder-gray-600" value={myPlayer.name} onChange={e=>setMyPlayer({...myPlayer, name: e.target.value})} />
                            <button onClick={joinRoom} className="bg-green-600 hover:bg-green-500 w-full py-8 rounded-2xl font-bold text-5xl text-white shadow-lg btn-push mt-4 border-b-8 border-green-800 active:border-b-0 active:translate-y-2">åŠ å…¥æˆ°å±€</button>
                        </div>
                    </div>
                </div>
            );

            // 2. Host
            if (view === 'host') {
                const totalPlayers = players.length;
                const answeredCount = players.filter(p => p.lastQ === gameState.qIndex).length;
                
                return (
                <div className="min-h-screen flex flex-col">
                    <SoundToggle />
                    <div className="p-6 bg-gray-800/80 flex justify-between items-center shadow-md z-10 border-b border-gray-600 backdrop-blur-md">
                        <div className="bg-yellow-500 text-black px-6 py-3 rounded-2xl font-mono font-bold text-4xl shadow-lg border-4 border-yellow-300">æˆ¿é–“ï¼š{roomCode}</div>
                        <div className="text-4xl font-bold">ç·šä¸Šï¼š<span className="text-green-400 text-5xl">{totalPlayers}</span> äºº</div>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center p-4 text-center overflow-y-auto">
                        {gameState.step === 'lobby' && (
                            <div className="animate-pop w-full max-w-5xl">
                                <h2 className="text-6xl font-black mb-12 text-gray-300">è«‹æ‰‹æ©Ÿè¼¸å…¥æˆ¿é–“è™Ÿ</h2>
                                <div className="text-[12rem] font-mono font-black text-yellow-400 leading-none mb-16 drop-shadow-[0_0_30px_rgba(250,204,21,0.5)]">{roomCode}</div>
                                <button onClick={() => hostAction('start')} disabled={isProcessing} className={`bg-green-600 hover:bg-green-500 px-20 py-8 rounded-full text-6xl font-bold shadow-2xl btn-push ${isProcessing ? 'btn-disabled' : ''} border-8 border-green-800`}>é–‹å§‹éŠæˆ² ğŸš€</button>
                            </div>
                        )}

                        {(gameState.step === 'question' || gameState.step === 'reveal') && (
                            <div className="w-full max-w-7xl animate-pop relative">
                                {gameState.step === 'question' && (
                                    <div className={`absolute -top-12 right-0 bg-gray-900 border-4 ${timer <= 5 ? 'border-red-500 text-red-500 animate-pulse-fast' : 'border-blue-500 text-blue-400'} rounded-full w-32 h-32 flex items-center justify-center text-7xl font-black shadow-2xl`}>
                                        {timer}
                                    </div>
                                )}
                                <div className="flex justify-between items-end mb-8">
                                    <div className="text-3xl text-gray-400 font-bold tracking-widest uppercase">Q{gameState.qIndex + 1}</div>
                                    <div className="text-4xl font-bold bg-gray-800/80 px-6 py-2 rounded-full border border-gray-500">
                                        å·²å›ç­”ï¼š<span className={answeredCount===totalPlayers ? "text-green-400" : "text-yellow-400"}>{answeredCount}</span> / {totalPlayers}
                                    </div>
                                </div>
                                <h2 className="text-5xl md:text-7xl font-black mb-16 leading-tight drop-shadow-lg text-white neon-text">{QUESTIONS[gameState.qIndex].q}</h2>
                                <div className="grid grid-cols-2 gap-8">
                                    {QUESTIONS[gameState.qIndex].opts.map((opt, idx) => (
                                        <div key={idx} className={`p-10 text-4xl md:text-5xl font-bold rounded-3xl text-left border-4 transition-all duration-300 ${gameState.showAnswer ? (idx === QUESTIONS[gameState.qIndex].ans ? 'bg-green-800 border-green-400 scale-105 shadow-[0_0_50px_rgba(34,197,94,0.8)] z-10' : 'bg-gray-800 border-transparent opacity-30 grayscale') : 'bg-gray-800/80 border-gray-600 hover:border-gray-400 hover:bg-gray-700'}`}>{opt}</div>
                                    ))}
                                </div>
                                {gameState.showAnswer && <div className="mt-12 animate-pop"><div className="inline-block bg-yellow-900/90 border-4 border-yellow-500 text-yellow-300 text-4xl font-bold px-12 py-6 rounded-3xl shadow-2xl backdrop-blur-xl">ğŸ’¡ è§£æï¼š{QUESTIONS[gameState.qIndex].note}</div></div>}
                            </div>
                        )}

                        {gameState.step === 'leaderboard' && (
                            <div className="w-full max-w-4xl animate-pop">
                                <h2 className="text-6xl font-black mb-12 text-yellow-400 drop-shadow-lg neon-text">ğŸ† Top 5 æˆ°æ³ ğŸ†</h2>
                                <div className="space-y-6">
                                    {players.slice(0, 5).map((p, idx) => (
                                        <div key={p.id} className={`flex justify-between items-center p-8 rounded-3xl text-4xl font-bold border-4 shadow-xl ${idx === 0 ? 'bg-gradient-to-r from-yellow-600 to-yellow-400 text-black border-white scale-110 z-10' : 'bg-gray-800/80 border-gray-600'}`}>
                                            <div className="flex gap-8 items-center"><span className={`w-16 h-16 flex items-center justify-center rounded-full text-3xl ${idx===0 ? 'bg-white text-yellow-600' : 'bg-gray-700 text-gray-400'}`}>{idx+1}</span><span>{p.name}</span></div><div className="font-mono text-5xl">{p.score}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {gameState.step === 'end' && (
                            <div className="animate-pop w-full max-w-5xl">
                                <div className="text-[8rem] mb-8 animate-bounce">ğŸ‘‘</div>
                                <h1 className="text-8xl font-black text-yellow-400 mb-12 drop-shadow-lg neon-text">æœ€çµ‚å† è»</h1>
                                <div className="text-8xl font-bold mb-16 text-white bg-red-600 py-8 px-16 rounded-3xl inline-block shadow-2xl border-8 border-yellow-400">{players[0]?.name}</div>
                                <div className="text-6xl text-gray-300">ç¸½åˆ†ï¼š{players[0]?.score}</div>
                                <div className="mt-12 grid grid-cols-2 gap-6 opacity-80">
                                    {players.slice(1, 5).map((p, idx) => (
                                        <div key={p.id} className="bg-gray-800 p-6 rounded-2xl text-3xl flex justify-between px-8 border border-gray-600">
                                            <span>#{idx+2} {p.name}</span> <span className="text-yellow-400">{p.score}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {gameState.step !== 'lobby' && gameState.step !== 'end' && (
                        <div className="p-8 bg-gray-800/90 flex justify-center gap-8 border-t-2 border-gray-600 backdrop-blur-md">
                            {gameState.step === 'question' && <button onClick={() => hostAction('reveal')} disabled={isProcessing} className={`bg-yellow-600 hover:bg-yellow-500 px-12 py-6 rounded-2xl font-bold text-3xl shadow-lg btn-push ${isProcessing ? 'btn-disabled' : ''}`}>å¼·åˆ¶å…¬ä½ˆç­”æ¡ˆ</button>}
                            {gameState.step === 'reveal' && <button onClick={() => hostAction('leaderboard')} disabled={isProcessing} className={`bg-blue-600 hover:bg-blue-500 px-12 py-6 rounded-2xl font-bold text-3xl shadow-lg btn-push ${isProcessing ? 'btn-disabled' : ''}`}>çœ‹æ’è¡Œ</button>}
                            {gameState.step === 'leaderboard' && <button onClick={() => hostAction('nextQ')} disabled={isProcessing} className={`bg-green-600 hover:bg-green-500 px-12 py-6 rounded-2xl font-bold text-3xl shadow-lg btn-push ${isProcessing ? 'btn-disabled' : ''}`}>ä¸‹ä¸€é¡Œ âœ</button>}
                        </div>
                    )}
                </div>
                );
            }

            // 3. Player
            if (view === 'player') {
                const myRank = players.findIndex(p => p.id === myPlayer.uid) + 1;
                return (
                <div className="min-h-screen flex flex-col p-4">
                    <div className="flex justify-between items-center mb-6 bg-gray-800/80 p-4 rounded-2xl shadow-md border-2 border-gray-600 backdrop-blur-sm">
                        <div className="font-bold text-3xl truncate max-w-[150px]">{myPlayer.name}</div> 
                        <div className="flex gap-3">
                            {myRank > 0 && <div className="bg-blue-700 px-4 py-2 rounded-xl font-mono font-bold text-2xl">#{myRank}</div>}
                            <div className="bg-gray-700 px-4 py-2 rounded-xl font-mono font-bold text-yellow-400 text-2xl">{myPlayer.score}</div>
                        </div>
                    </div>
                    <div className="flex-1 flex flex-col justify-center text-center">
                        {gameState.step === 'lobby' && <div className="animate-pulse flex flex-col items-center"><div className="text-9xl mb-8">â³</div><h2 className="text-5xl font-bold mb-4">é€£ç·šæˆåŠŸï¼</h2><p className="text-gray-400 text-2xl">è«‹çœ‹å¤§è¢å¹•ï¼Œç­‰å¾…é–‹å§‹...</p></div>}
                        {gameState.step === 'question' && gameState.qIndex !== myPlayer.lastQ && (
                            <div className="grid grid-cols-2 gap-6 h-full max-h-[700px]">
                                {['A', 'B', 'C', 'D'].map((label, idx) => (
                                    <button key={idx} onClick={() => playerAnswer(idx)} className={`rounded-3xl text-8xl font-black text-white shadow-xl btn-push flex items-center justify-center border-b-[12px] active:border-b-0 active:translate-y-4 transition-all ${['bg-red-600 border-red-900', 'bg-blue-600 border-blue-900', 'bg-yellow-500 border-yellow-800', 'bg-green-600 border-green-900'][idx]}`}>{label}</button>
                                ))}
                                <p className="col-span-2 text-gray-400 mt-4 font-bold text-2xl animate-pulse">è«‹çœ‹å¤§è¢å¹•ä½œç­”</p>
                            </div>
                        )}
                        {gameState.step === 'question' && gameState.qIndex === myPlayer.lastQ && <div className="animate-pop"><div className="text-9xl mb-8 animate-bounce">ğŸš€</div><h2 className="text-6xl font-black text-green-400 mb-4">ç­”æ¡ˆå·²é€å‡º</h2><p className="text-gray-300 text-3xl">è«‹ç­‰å¾…çµæœ...</p></div>}
                        {(gameState.step === 'reveal' || gameState.step === 'leaderboard') && <div className="bg-gray-800 p-10 rounded-3xl shadow-xl border-4 border-gray-600"><h2 className="text-5xl font-bold mb-6">æœ¬é¡ŒçµæŸ</h2><p className="text-gray-400 text-3xl">æ­£ç¢ºç­”æ¡ˆè«‹çœ‹å¤§è¢å¹•</p></div>}
                        {gameState.step === 'end' && <div className="animate-pop"><h2 className="text-5xl font-bold mb-8">æœ€çµ‚å¾—åˆ†</h2><div className="text-[6rem] font-mono font-black text-yellow-400 mb-8">{myPlayer.score}</div><div className="text-gray-400 text-3xl">æ„Ÿè¬åƒèˆ‡ï¼</div></div>}
                    </div>
                </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
