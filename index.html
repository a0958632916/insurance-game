<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±ºæˆ°åœ‹æ³°é‡‘é ­è…¦</title>
    
    <!-- 1. æ ¸å¿ƒå¼•æ“ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- 3. ç‰¹æ•ˆåº« (å½©å¸¶) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* ğŸ¨ è¦–è¦ºæ ¸å¿ƒï¼šè˜­åŸæ™¶è‹±å°ˆç”¨ (æ·±æµ·è»è— + æµé‡‘) */
        body { 
            background: radial-gradient(circle at center, #172554 0%, #020617 100%); 
            color: #ffffff; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
            overflow-x: hidden; 
            touch-action: manipulation; /* ç¦æ­¢é›™æ“Šç¸®æ”¾ */
            -webkit-tap-highlight-color: transparent;
        }

        /* âœ¨ æ¨™é¡Œé‡‘å…‰ç‰¹æ•ˆ */
        .title-gold {
            color: #facc15;
            text-shadow: 3px 3px 0px #000, 0 0 20px rgba(250, 204, 21, 0.6);
        }
        
        /* ğŸ‘“ é«˜å°æ¯”æŠ•å½±å„ªåŒ– */
        .text-shadow-strong { text-shadow: 2px 2px 0px #000000; }

        /* ğŸ”˜ æŒ‰éˆ•ç«‹é«”æ„Ÿ */
        .btn-push { transition: all 0.1s; transform: translateY(0); box-shadow: 0 8px 0 rgba(0,0,0,0.4); } 
        .btn-push:active:not(:disabled) { transform: translateY(8px); box-shadow: 0 0 0 rgba(0,0,0,0); }
        .btn-disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(100%); transform: none !important; box-shadow: none !important; }
        
        /* ğŸ“± æ‰‹æ©Ÿç«¯ï¼šç”°å­—å‹è¶…å¤§æŒ‰éˆ• */
        .grid-btn-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 16px; /* åŠ å¤§é–“è·é˜²èª¤è§¸ */
            height: 60vh;
            width: 100%;
            padding: 10px;
        }

        /* DJ é¢æ¿éš±è—å·è»¸ä½†å¯æ»‘å‹• */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* å‹•ç•« */
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-pulse-fast { animation: pulse 0.8s infinite; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // 1. ç³»çµ±è¨­å®š (å·²å¯«æ­»ï¼Œå…è¼¸å…¥)
        // ==========================================
        const FIREBASE_CONFIG = {
            projectId: "cathaylife-e0714", 
            apiKey: "AIzaSyDoeEnc5-cebY6RfWAYnGM5y1BwLHFG5_g"    
        };

        // ğŸµ éŸ³æ•ˆåŒ…è¨­å®š (10å¤§é¢¨æ ¼ DJ å°)
        const SOUND_PACKS = {
            variety: { name: "ğŸ‰ ç¶œè—", lobby: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3", game: "https://assets.mixkit.co/active_storage/sfx/896/896-preview.mp3", correct: "https://www.myinstants.com/media/sounds/super-mario-coin.mp3", victory: "https://www.myinstants.com/media/sounds/final-fantasy-v-music-victory-fanfare.mp3" },
            tension: { name: "âš¡ ç·Šå¼µ", lobby: "https://assets.mixkit.co/active_storage/sfx/123/123-preview.mp3", game: "https://assets.mixkit.co/active_storage/sfx/255/255-preview.mp3", correct: "https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3", victory: "https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" },
            epic: { name: "ğŸ» å²è©©", lobby: "https://assets.mixkit.co/active_storage/sfx/888/888-preview.mp3", game: "https://assets.mixkit.co/active_storage/sfx/131/131-preview.mp3", correct: "https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3", victory: "https://assets.mixkit.co/active_storage/sfx/2020/2020-preview.mp3" },
            retro: { name: "ğŸ‘¾ é›»ç©", lobby: "https://assets.mixkit.co/active_storage/sfx/446/446-preview.mp3", game: "https://assets.mixkit.co/active_storage/sfx/447/447-preview.mp3", correct: "https://www.myinstants.com/media/sounds/1-up-mario.mp3", victory: "https://www.myinstants.com/media/sounds/stage-clear.mp3" },
            chill: { name: "â˜• çˆµå£«", lobby: "https://assets.mixkit.co/active_storage/sfx/147/147-preview.mp3", game: "https://assets.mixkit.co/active_storage/sfx/896/896-preview.mp3", correct: "https://www.myinstants.com/media/sounds/ding-sound-effect_2.mp3", victory: "https://www.myinstants.com/media/sounds/tada-fanfare-a.mp3" },
            horror: { name: "ğŸ‘» æ‡¸ç–‘", lobby: "https://assets.mixkit.co/active_storage/sfx/134/134-preview.mp3", game: "https://assets.mixkit.co/active_storage/sfx/307/307-preview.mp3", correct: "https://assets.mixkit.co/active_storage/sfx/2059/2059-preview.mp3", victory: "https://assets.mixkit.co/active_storage/sfx/2020/2020-preview.mp3" },
            rock: { name: "ğŸ¸ æ–æ»¾", lobby: "https://assets.mixkit.co/active_storage/sfx/116/116-preview.mp3", game: "https://assets.mixkit.co/active_storage/sfx/262/262-preview.mp3", correct: "https://assets.mixkit.co/active_storage/sfx/3004/3004-preview.mp3", victory: "https://assets.mixkit.co/active_storage/sfx/2021/2021-preview.mp3" },
            cute: { name: "ğŸ‘¶ å¯æ„›", lobby: "https://assets.mixkit.co/active_storage/sfx/97/97-preview.mp3", game: "https://assets.mixkit.co/active_storage/sfx/96/96-preview.mp3", correct: "https://assets.mixkit.co/active_storage/sfx/1110/1110-preview.mp3", victory: "https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" },
            scifi: { name: "ğŸ¤– ç§‘å¹»", lobby: "https://assets.mixkit.co/active_storage/sfx/119/119-preview.mp3", game: "https://assets.mixkit.co/active_storage/sfx/366/366-preview.mp3", correct: "https://assets.mixkit.co/active_storage/sfx/2002/2002-preview.mp3", victory: "https://assets.mixkit.co/active_storage/sfx/2016/2016-preview.mp3" },
            drum: { name: "ğŸ¥ æˆ°é¼“", lobby: "https://assets.mixkit.co/active_storage/sfx/130/130-preview.mp3", game: "https://assets.mixkit.co/active_storage/sfx/131/131-preview.mp3", correct: "https://assets.mixkit.co/active_storage/sfx/2060/2060-preview.mp3", victory: "https://assets.mixkit.co/active_storage/sfx/2022/2022-preview.mp3" }
        };

        // é¡å¤–éŸ³æ•ˆï¼šæ­¡å‘¼è² (æ‰‹å‹•æ’­æ”¾ç”¨)
        const CHEER_SOUND = "https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3";

        // ==========================================
        // 2. é¡Œç›®å€
        // ==========================================
        const QUESTIONS = [
            { q: "é‡å°ç”·æ€§èˆ‡å¥³æ€§å®¹æ˜“ç™¼ç”Ÿçš„ç‰¹å®šç™Œç—‡ï¼Œå“ªä¸€å°ã€Œæƒ…ä¾¶æª”ã€å•†å“å¯åŠ ç¢¼çµ¦ä»˜ 50%ï¼Ÿ", opts: ["(A) ç¾…å¯†æ­ èˆ‡ èŒ±éº—è‘‰", "(B) è±ªåº·æ„›(ç”·) èˆ‡ å¥½åº·æ„›(å¥³)", "(C) çœŸå¿ƒå®‰ èˆ‡ çœŸå®‰å®‰", "(D) å¤§é™¸æ–°å¨˜ èˆ‡ å°ç£éƒ"], ans: 1, note: "é‡å°ç‰¹å®šæ€§åˆ¥ç™Œç—‡ï¼Œç¬¬6å¹´å¾Œæœ€é«˜é¡å¤–çµ¦ä»˜ 50%ã€‚" },
            { q: "å“ªä¸€å¼µç¾å…ƒä¿å–®ï¼Œåå­—è½èµ·ä¾†ã€Œå¥åº·åˆè³ºéŒ¢ã€ï¼Œä¸”å…¼é¡§ã€Œç™Œç—‡(é‡åº¦)æå‰çµ¦ä»˜ã€ï¼Ÿ", opts: ["(A) ç¾æ„›åº·ç›ˆ", "(B) ç¾åˆ©ç››è®š", "(C) ç¾æ»¿é›™å¯¶", "(D) ç¾éº—äººç”Ÿ"], ans: 0, note: "ã€Œç¾æ„›åº·ç›ˆã€åˆ©è®Šå‹ + ç™Œç—‡æå‰çµ¦ä»˜ï¼Œå…¼é¡§è²¡å¯Œèˆ‡å¥åº·ã€‚" },
            { q: "é‡å°é«˜é½¡æ—ç¾¤(55-75æ­²)ï¼Œåªè¦æ´»åˆ°91æ­²å°±èƒ½é ˜å›ä¸€åŠä¿è²»çš„æ„å¤–éšªæ˜¯ï¼Ÿ", opts: ["(A) æ¨‚äº«å¹³å®‰", "(B) é ¤é¤Šå¤©å¹´", "(C) é•·å‘½ç™¾æ­²", "(D) ç¦å¦‚æ±æµ·"], ans: 0, note: "ã€Œæ¨‚äº«å¹³å®‰ã€é‡å°é«˜é½¡è¨­è¨ˆï¼Œ91æ­²ä»ç”Ÿå­˜çµ¦ä»˜ç¸½ä¿è²» 50%ã€‚" },
            { q: "ä¿éšªæ¥­å‹™å“¡æœ€å²å®³çš„è¶…èƒ½åŠ›æ˜¯ä»€éº¼ï¼Ÿ", opts: ["(A) éš±å½¢", "(B) ä»»ä½•è©±é¡Œéƒ½èƒ½èŠåˆ°ä¿éšª", "(C) é£›è¡Œ", "(D) å¥½è…°åŠ›"], ans: 1, note: "é€™å°±æ˜¯å°ˆæ¥­ï¼éš¨æ™‚éš¨åœ°æ•£æ’­æ„›çš„ç¨®å­ï¼" },
            { q: "é‡åˆ°ã€Œå¥§å®¢ã€çš„æ™‚å€™ï¼Œå¿ƒè£¡è¦é»˜å¿µä»€éº¼å’’èªï¼Ÿ", opts: ["(A) åŠ ä¸Šå»ï¼çµ¦ä»–æ­»ï¼", "(B) è«ç”Ÿæ°£ï¼Œæ°£å‡ºç—…ä¾†ç„¡äººæ›¿", "(C) èˆ¬è‹¥æ³¢ç¾…èœœ", "(D) æ€¥æ€¥å¦‚å¾‹ä»¤"], ans: 1, note: "æˆ–æ˜¯é»˜å¿µï¼šã€Œä¸‹ä¸€ä½æœƒæ›´å¥½ï¼ã€ä¿æŒæ­£èƒ½é‡ã€‚" },
            { q: "å®œè˜­å¤šé›¨è·¯æ»‘ï¼Œé¨æ©Ÿè»Šæ€•çŠç”°ã€‚å“ªå¼µé™„ç´„æ˜¯ã€Œéª¨æŠ˜æ•‘æ˜Ÿã€ï¼Œé€£è„«è‡¼éƒ½è³ ï¼Ÿ", opts: ["(A) å‹å‹‡å¥", "(B) æ–°é‡‘éª¨åŠ›", "(C) éµç‰›é‹åŠŸæ•£", "(D) çœŸçš„å¥½ç—›"], ans: 1, note: "ã€Œæ–°é‡‘éª¨åŠ›ã€é‡å°éª¨æŠ˜ã€è„«è‡¼æœ‰ç‰¹åˆ¥ä¿éšœï¼Œæ©Ÿè»Šæ—å¿…å‚™ã€‚" },
            { q: "ã€è…¦ç­‹æ€¥è½‰å½ã€‘ä¸€éš»å…¬é›ååœ¨å±‹é ‚ä¸Šï¼Œè«‹å•ç‰ ä¸‹çš„è›‹æœƒå¾€å“ªé‚Šæ‰ï¼Ÿ", opts: ["(A) å·¦é‚Š", "(B) å³é‚Š", "(C) å±‹é ‚ä¸­é–“", "(D) å…¬é›ä¸æœƒä¸‹è›‹"], ans: 3, note: "ç¶“å…¸é™·é˜±é¡Œï¼å…¬é›æ˜¯ä¸æœƒä¸‹è›‹çš„ï¼" },
            { q: "ã€è…¦ç­‹æ€¥è½‰å½ã€‘å“ªä¸€å€‹å¡é€šäººç‰©æœ€å–œæ­¡å¹«åŠ©åˆ¥äººï¼Ÿ", opts: ["(A) å“†å•¦Aå¤¢", "(B) å·§è™", "(C) ä½©ä½©è±¬", "(D) éºµåŒ…è¶…äºº"], ans: 1, note: "å› ç‚ºã€Œå·§è™ã€æ•‘æ´ (å‰›å¥½æ•‘äºº)ï¼å°èªè«§éŸ³æ¢—ï¼" },
            { q: "å®œè˜­äººå£é ­ç¦ªï¼Œå½¢å®¹æ±è¥¿ã€Œå¾ˆæ£’ã€å¾ˆå¼·ã€æœƒèªªï¼Ÿ", opts: ["(A) æ°´å•¦", "(B) å‹ (Kå‹)", "(C) ç‹‚", "(D) é ‚"], ans: 1, note: "å®œè˜­äººæ‰æ‡‚ï¼å‹å¥½å‘·ï¼å‹å²å®³ï¼" },
            { q: "å®œè˜­é„‰è¦ªæƒ³æŠŠéŒ¢çœä¸‹ä¾†é¤Šè€ï¼Œå“ªå¼µé˜²ç™Œéšªã€Œ30å¹´æ²’ç†è³ ã€å¯æ‹¿å›éŒ¢ï¼Ÿ", opts: ["(A) æ»¿æº¢åº·æ„›", "(B) æ»¿æ‰‹ç¾é‡‘", "(C) æº¢èµ·å»ç©", "(D) åº·åº·èˆ"], ans: 0, note: "ã€Œæ»¿æº¢åº·æ„›ã€æ²’ç”¨åˆ°é‚„èƒ½æ‹¿å›ä¾†ï¼Œç²¾æ‰“ç´°ç®—é¦–é¸ã€‚" }
        ];

        function App() {
            const [view, setView] = useState('role-select'); 
            const [db, setDb] = useState(null);
            const [roomCode, setRoomCode] = useState('');
            const [gameState, setGameState] = useState({});
            const [myPlayer, setMyPlayer] = useState({ name: '', score: 0 });
            const [players, setPlayers] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [timer, setTimer] = useState(10); 
            const revealedRef = useRef(false);

            // éŸ³æ•ˆèˆ‡ DJ ç³»çµ±
            const [isMuted, setIsMuted] = useState(false);
            const [currentTheme, setCurrentTheme] = useState('variety');
            const audioRef = useRef(null);
            const cheerRef = useRef(new Audio(CHEER_SOUND));

            useEffect(() => {
                // åˆå§‹åŒ–é è¨­éŸ³æ•ˆ
                audioRef.current = {
                    lobby: new Audio(SOUND_PACKS[currentTheme].lobby),
                    game: new Audio(SOUND_PACKS[currentTheme].game),
                    correct: new Audio(SOUND_PACKS[currentTheme].correct),
                    victory: new Audio(SOUND_PACKS[currentTheme].victory)
                };
                audioRef.current.lobby.loop = true;
                audioRef.current.lobby.volume = 0.5;
                audioRef.current.game.loop = true;
                audioRef.current.game.volume = 0.4;

                if (!firebase.apps.length) {
                    try {
                        firebase.initializeApp({
                            apiKey: FIREBASE_CONFIG.apiKey,
                            authDomain: `${FIREBASE_CONFIG.projectId}.firebaseapp.com`,
                            projectId: FIREBASE_CONFIG.projectId
                        });
                        setDb(firebase.firestore());
                    } catch (error) { alert("é€£ç·šéŒ¯èª¤"); }
                } else { setDb(firebase.firestore()); }

                // æ–·ç·šé‡é€£
                const savedRoom = sessionStorage.getItem('host_room_code');
                if (savedRoom) setRoomCode(savedRoom);
            }, []);

            // ğŸµ åˆ‡æ›ä¸»é¡Œé‚è¼¯
            const changeTheme = (themeKey) => {
                if (view !== 'host') return;
                audioRef.current.lobby.pause();
                audioRef.current.game.pause();

                audioRef.current.lobby.src = SOUND_PACKS[themeKey].lobby;
                audioRef.current.game.src = SOUND_PACKS[themeKey].game;
                audioRef.current.correct.src = SOUND_PACKS[themeKey].correct;
                audioRef.current.victory.src = SOUND_PACKS[themeKey].victory;

                setCurrentTheme(themeKey);

                if (!isMuted) {
                    if (gameState.step === 'lobby') audioRef.current.lobby.play().catch(()=>{});
                    else if (['question', 'reveal', 'leaderboard'].includes(gameState.step)) audioRef.current.game.play().catch(()=>{});
                }
            };

            // ğŸµ æ’­æ”¾é‚è¼¯
            useEffect(() => {
                if (isMuted || view !== 'host') {
                    if (audioRef.current) {
                        audioRef.current.lobby.pause();
                        audioRef.current.game.pause();
                    }
                    return;
                }
                
                if (audioRef.current) {
                    audioRef.current.lobby.pause();
                    audioRef.current.game.pause();

                    if (gameState.step === 'lobby') audioRef.current.lobby.play().catch(e=>{});
                    else if (['question', 'reveal', 'leaderboard'].includes(gameState.step)) audioRef.current.game.play().catch(e=>{});
                }
            }, [gameState.step, view, isMuted, currentTheme]);

            const playSound = (type) => {
                if (isMuted || view !== 'host') return;
                const sound = audioRef.current[type];
                if (sound) { sound.currentTime = 0; sound.play().catch(()=>{}); }
            };

            const playCheer = () => {
                if (isMuted || view !== 'host') return;
                cheerRef.current.currentTime = 0;
                cheerRef.current.play().catch(()=>{});
            };

            const toggleMute = () => {
                if (view !== 'host') return;
                setIsMuted(prev => !prev);
            };

            // â±ï¸ è¨ˆæ™‚å™¨é‚è¼¯
            useEffect(() => {
                if (gameState.step === 'question') {
                    setTimer(10);
                    revealedRef.current = false;
                }
            }, [gameState.qIndex, gameState.step]);

            useEffect(() => {
                let interval;
                if (view === 'host' && gameState.step === 'question' && !revealedRef.current) {
                    // 1. å€’æ•¸
                    if (timer > 0) {
                        interval = setInterval(() => setTimer(t => t - 1), 1000);
                    } 
                    // 2. æ™‚é–“åˆ° -> è‡ªå‹•å…¬ä½ˆ
                    else if (timer === 0 && !isProcessing) {
                        revealedRef.current = true;
                        hostAction('reveal');
                    }

                    // 3. å…¨å“¡ä½œç­” -> ææ—©å…¬ä½ˆ (ç·©è¡ 0.8s)
                    if (players.length > 0) {
                        const answeredCount = players.filter(p => p.lastQ === gameState.qIndex).length;
                        if (answeredCount === players.length && answeredCount > 0 && !isProcessing) {
                            revealedRef.current = true;
                            setTimeout(() => hostAction('reveal'), 800);
                        }
                    }
                }
                return () => clearInterval(interval);
            }, [view, gameState.step, timer, players, isProcessing]);

            const sortPlayers = (list) => {
                return list.sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.name.localeCompare(b.name);
                });
            };

            // ğŸ‰ å½©å¸¶ç‰¹æ•ˆ
            const fireConfetti = () => {
                const duration = 5 * 1000;
                const animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
                const randomInRange = (min, max) => Math.random() * (max - min) + min;

                const interval = setInterval(function() {
                    const timeLeft = animationEnd - Date.now();
                    if (timeLeft <= 0) { return clearInterval(interval); }
                    const particleCount = 50 * (timeLeft / duration);
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
                }, 250);
            };

            // --- Host Functions ---
            const initHost = async () => {
                if(!db) return;
                const savedRoom = sessionStorage.getItem('host_room_code');
                if (savedRoom) {
                    const doc = await db.collection('rooms').doc(savedRoom).get();
                    if (doc.exists) {
                        setRoomCode(savedRoom);
                        startHostListeners(savedRoom);
                        return;
                    }
                }
                createRoom();
            };

            const createRoom = async () => {
                const code = Math.floor(1000 + Math.random() * 9000).toString();
                setRoomCode(code);
                sessionStorage.setItem('host_room_code', code);
                await db.collection('rooms').doc(code).set({
                    step: 'lobby', qIndex: 0, showAnswer: false, 
                    startTime: 0, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                startHostListeners(code);
            };

            const startHostListeners = (code) => {
                db.collection('rooms').doc(code).onSnapshot(doc => setGameState(doc.data()));
                db.collection('rooms').doc(code).collection('players').onSnapshot(snap => {
                    const list = []; 
                    snap.forEach(d => list.push({id: d.id, ...d.data()}));
                    setPlayers(sortPlayers(list));
                });
                setView('host');
            };

            const hostAction = async (action) => {
                if(!db || isProcessing) return;
                
                if (action === 'reveal' && gameState.step === 'reveal') return;
                if (action === 'start' && gameState.step === 'question') return;

                setIsProcessing(true);

                try {
                    const ref = db.collection('rooms').doc(roomCode);
                    if (action === 'reveal') {
                        playSound('correct');
                        await ref.update({ showAnswer: true, step: 'reveal' });
                    } else if (action === 'end') {
                        playSound('victory');
                        fireConfetti();
                    } else if (action === 'start' || action === 'nextQ') {
                        const nextIdx = action === 'start' ? 0 : gameState.qIndex + 1;
                        if (action === 'nextQ' && nextIdx >= QUESTIONS.length) {
                            playSound('victory'); 
                            fireConfetti();
                            await ref.update({ step: 'end' });
                        } else {
                            await ref.update({ step: 'question', qIndex: nextIdx, showAnswer: false, startTime: Date.now() });
                        }
                    } else if (action === 'leaderboard') {
                        await ref.update({ step: 'leaderboard' });
                    }
                } catch (e) { console.error(e); } 
                finally { setTimeout(() => setIsProcessing(false), 1000); }
            };

            // --- Player Functions ---
            const joinRoom = async () => {
                if(!db) return alert("é€£ç·šä¸­...");
                if(!roomCode || !myPlayer.name) return alert("è«‹è¼¸å…¥æˆ¿é–“è™Ÿèˆ‡æš±ç¨±");
                const roomRef = db.collection('rooms').doc(roomCode);
                try {
                    const doc = await roomRef.get();
                    if(!doc.exists) return alert("æˆ¿é–“ä¸å­˜åœ¨");
                    const uid = Math.random().toString(36).substr(2, 9);
                    await roomRef.collection('players').doc(uid).set({ name: myPlayer.name, score: 0, lastQ: -1 });
                    setMyPlayer({...myPlayer, uid});
                    roomRef.onSnapshot(doc => setGameState(doc.data()));
                    roomRef.collection('players').doc(uid).onSnapshot(doc => { if(doc.exists) setMyPlayer(p => ({...p, ...doc.data()})); });
                    roomRef.collection('players').onSnapshot(snap => {
                        const list = []; snap.forEach(d => list.push({id: d.id, ...d.data()}));
                        setPlayers(sortPlayers(list));
                    });
                    setView('player');
                } catch (e) { alert("é€£ç·šå¤±æ•—"); }
            };

            const playerAnswer = async (optIndex) => {
                if (gameState.step !== 'question' || gameState.qIndex === myPlayer.lastQ) return;
                const currentQ = QUESTIONS[gameState.qIndex];
                const isCorrect = optIndex === currentQ.ans;
                let points = 0;
                if (isCorrect) {
                    const now = Date.now();
                    const start = gameState.startTime || now;
                    const elapsedSec = (now - start) / 1000;
                    points = Math.max(200, Math.round(1000 - (elapsedSec * 60))); // æ¥µé€Ÿè¨ˆåˆ†
                }
                const roomRef = db.collection('rooms').doc(roomCode);
                setMyPlayer(p => ({...p, lastQ: gameState.qIndex}));
                try {
                    await roomRef.collection('players').doc(myPlayer.uid).update({
                        score: firebase.firestore.FieldValue.increment(points), lastQ: gameState.qIndex
                    });
                } catch(e) { console.error("Answer failed"); }
            };

            // DJ é¢æ¿ (åƒ… Host, å¯æ”¶åˆ)
            const DjPanel = () => {
                const [isOpen, setIsOpen] = useState(false);
                if (view !== 'host') return null;
                
                return (
                    <div className="fixed top-4 right-4 z-50 flex flex-col items-end gap-2">
                        <div className="flex gap-2">
                            <button 
                                onClick={() => setIsOpen(!isOpen)} 
                                className={`p-3 rounded-full shadow-lg border-2 transition w-14 h-14 flex items-center justify-center text-2xl ${isOpen ? 'bg-yellow-400 text-black border-yellow-200' : 'bg-gray-800 text-white border-gray-500 hover:bg-gray-700'}`}
                                title="DJ éŸ³æ§å°"
                            >
                                ğŸµ
                            </button>
                            <button 
                                onClick={toggleMute} 
                                className="bg-white text-black p-3 rounded-full shadow-lg border-2 border-gray-300 hover:bg-gray-100 transition w-14 h-14 flex items-center justify-center text-2xl"
                                title={isMuted ? "å–æ¶ˆéœéŸ³" : "éœéŸ³"}
                            >
                                {isMuted ? "ğŸ”‡" : "ğŸ”Š"}
                            </button>
                        </div>

                        {isOpen && (
                            <div className="bg-black/90 backdrop-blur-md p-3 rounded-xl border border-gray-500 shadow-2xl flex flex-col gap-2 mt-2 animate-pop origin-top-right w-56 max-h-[400px] overflow-y-auto">
                                <div className="text-gray-400 text-xs font-bold text-center mb-1">é¸æ“‡éŸ³æ¨‚é¢¨æ ¼</div>
                                <div className="grid grid-cols-2 gap-2">
                                    {Object.keys(SOUND_PACKS).map(key => (
                                        <button 
                                            key={key}
                                            onClick={() => changeTheme(key)}
                                            className={`px-2 py-2 rounded-lg text-xs font-bold transition whitespace-nowrap ${currentTheme === key ? 'bg-yellow-400 text-black' : 'text-gray-300 hover:text-white bg-gray-700/50'}`}
                                        >
                                            {SOUND_PACKS[key].name}
                                        </button>
                                    ))}
                                </div>
                                <div className="h-px bg-gray-700 my-1"></div>
                                <button onClick={playCheer} className="w-full px-3 py-3 rounded-lg text-sm font-bold text-white bg-pink-600 hover:bg-pink-500 shadow-md animate-pulse-fast">
                                    ğŸ‘ æ’­æ”¾æ­¡å‘¼
                                </button>
                            </div>
                        )}
                    </div>
                );
            };

            // 1. Role Select
            if (view === 'role-select') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 space-y-12">
                    <DjPanel />
                    <div className="text-center">
                        <h1 className="text-6xl md:text-8xl font-black mb-4 title-gold">æ±ºæˆ°<br/>åœ‹æ³°é‡‘é ­è…¦</h1>
                        <h2 className="text-3xl md:text-5xl font-bold text-white text-shadow-strong">ğŸ’° åŠ ç¢¼å¹´çµ‚é€å¤ å¤  ğŸ’°</h2>
                    </div>
                    <div className="flex flex-col gap-8 w-full max-w-xl justify-center">
                        <button onClick={initHost} className="bg-blue-600 hover:bg-blue-500 w-full py-6 rounded-3xl text-3xl font-bold btn-push shadow-2xl border-4 border-blue-300 text-white flex justify-center items-center gap-4"><span>ğŸ“º</span> æˆ‘æ˜¯ä¸»æŒäºº</button>
                        <div className="bg-black/40 backdrop-blur-md w-full p-8 rounded-3xl flex flex-col justify-center space-y-6 shadow-2xl border-2 border-yellow-400/50">
                            <div className="text-center font-bold text-4xl mb-2 text-yellow-300 text-shadow-strong">ğŸ“± æˆ‘æ˜¯åƒè³½è€…</div>
                            <input placeholder="è¼¸å…¥æˆ¿é–“è™Ÿ" className="w-full p-6 bg-white/95 rounded-2xl text-center text-4xl font-bold outline-none text-black border-4 border-blue-500 focus:border-yellow-400 placeholder-gray-500" value={roomCode} onChange={e=>setRoomCode(e.target.value)} type="tel"/>
                            <input placeholder="è¼¸å…¥ä½ çš„åå­—" className="w-full p-6 bg-white/95 rounded-2xl text-center text-4xl font-bold outline-none text-black border-4 border-blue-500 focus:border-yellow-400 placeholder-gray-500" value={myPlayer.name} onChange={e=>setMyPlayer({...myPlayer, name: e.target.value})} />
                            <button onClick={joinRoom} className="bg-green-600 hover:bg-green-500 w-full py-8 rounded-2xl font-black text-5xl text-white shadow-lg btn-push mt-4 border-b-8 border-green-800">åŠ å…¥æˆ°å±€</button>
                        </div>
                    </div>
                </div>
            );

            // 2. Host
            if (view === 'host') {
                const totalPlayers = players.length;
                const answeredCount = players.filter(p => p.lastQ === gameState.qIndex).length;
                const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(window.location.href);
                
                const answerStats = [0, 0, 0, 0];
                if (gameState.showAnswer) {
                    players.forEach(p => {
                        if (p.lastQ === gameState.qIndex && p.lastSelection >= 0 && p.lastSelection < 4) {
                            answerStats[p.lastSelection]++;
                        }
                    });
                }

                return (
                <div className="min-h-screen flex flex-col">
                    <DjPanel />
                    <div className="p-6 bg-blue-900/80 flex justify-between items-center shadow-lg z-10 border-b-4 border-yellow-400 backdrop-blur-sm">
                        <div className="bg-yellow-400 text-black px-8 py-3 rounded-2xl font-black text-4xl shadow-md border-2 border-white">æˆ¿é–“ï¼š{roomCode}</div>
                        <div className="text-5xl font-black text-white text-shadow-strong">ç·šä¸Šï¼š<span className="text-yellow-400">{totalPlayers}</span> äºº</div>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center p-4 text-center overflow-y-auto">
                        {gameState.step === 'lobby' && (
                            <div className="animate-pop w-full max-w-5xl flex flex-col items-center">
                                <h2 className="text-7xl font-black mb-8 text-white text-shadow-strong">è«‹æƒæ QR Code</h2>
                                <div className="bg-white p-4 rounded-3xl shadow-2xl mb-8">
                                    <img src={qrUrl} alt="QR Code" className="w-[300px] h-[300px]" />
                                </div>
                                <h2 className="text-6xl font-black mb-4 text-white text-shadow-strong">æˆ–è¼¸å…¥æˆ¿é–“è™Ÿ</h2>
                                <div className="text-[14rem] font-mono font-black text-yellow-400 leading-none mb-12 text-shadow-strong">{roomCode}</div>
                                <button onClick={() => hostAction('start')} disabled={isProcessing} className={`bg-green-600 hover:bg-green-500 px-24 py-10 rounded-full text-7xl font-black shadow-2xl btn-push text-white border-8 border-white ${isProcessing ? 'btn-disabled' : ''}`}>é–‹å§‹éŠæˆ² ğŸš€</button>
                            </div>
                        )}

                        {(gameState.step === 'question' || gameState.step === 'reveal') && (
                            <div className="w-full max-w-7xl animate-pop relative">
                                {gameState.step === 'question' && (
                                    <div className={`absolute -top-20 right-0 bg-black border-8 ${timer <= 3 ? 'border-red-500 text-red-500 animate-pulse-fast' : 'border-yellow-400 text-yellow-400'} rounded-full w-48 h-48 flex items-center justify-center text-9xl font-black shadow-2xl z-20`}>
                                        {timer}
                                    </div>
                                )}
                                <div className="flex justify-between items-end mb-8">
                                    <div className="text-4xl text-blue-200 font-bold tracking-widest uppercase">QUESTION {gameState.qIndex + 1}</div>
                                    <div className="text-5xl font-bold bg-blue-900 px-8 py-3 rounded-full border-4 border-yellow-400 text-white shadow-lg">
                                        å·²ç­”ï¼š<span className={answeredCount===totalPlayers ? "text-green-400" : "text-yellow-400"}>{answeredCount}</span> / {totalPlayers}
                                    </div>
                                </div>
                                <h2 className="text-6xl md:text-7xl font-black mb-12 leading-tight text-white text-shadow-strong bg-black/40 p-8 rounded-3xl backdrop-blur-sm border-2 border-white/30">
                                    {QUESTIONS[gameState.qIndex].q}
                                </h2>
                                <div className="grid grid-cols-2 gap-8">
                                    {QUESTIONS[gameState.qIndex].opts.map((opt, idx) => (
                                        <div key={idx} className={`relative p-10 text-5xl font-bold rounded-3xl text-left border-4 transition-all duration-300 shadow-lg overflow-hidden ${
                                            gameState.showAnswer 
                                                ? (idx === QUESTIONS[gameState.qIndex].ans 
                                                    ? 'bg-green-600 border-white text-white scale-105 shadow-2xl z-10' 
                                                    : 'bg-gray-800 border-gray-600 text-gray-500 opacity-50')
                                                : 'bg-white text-blue-900 border-blue-300'
                                        }`}>
                                            {gameState.showAnswer && (
                                                <div 
                                                    className="absolute bottom-0 left-0 h-2 bg-yellow-400/50 bar-grow" 
                                                    style={{ width: `${(answerStats[idx] / Math.max(1, answeredCount)) * 100}%`, height: '100%' }}
                                                ></div>
                                            )}
                                            <div className="relative z-10 flex justify-between">
                                                <span>{opt}</span>
                                                {gameState.showAnswer && <span className="text-yellow-300 font-mono ml-4">{answerStats[idx]}äºº</span>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {gameState.showAnswer && <div className="mt-12 animate-pop"><div className="inline-block bg-yellow-400 border-8 border-white text-black text-5xl font-bold px-16 py-8 rounded-full shadow-2xl transform -rotate-1">ğŸ’¡ è§£æï¼š{QUESTIONS[gameState.qIndex].note}</div></div>}
                            </div>
                        )}

                        {gameState.step === 'leaderboard' && (
                            <div className="w-full max-w-5xl animate-pop">
                                <h2 className="text-7xl font-black mb-12 title-gold">ğŸ† æˆ°æ³æ’è¡Œæ¦œ (Top 6) ğŸ†</h2>
                                <div className="space-y-6">
                                    {players.slice(0, 6).map((p, idx) => (
                                        <div key={p.id} className={`flex justify-between items-center p-8 rounded-3xl text-5xl font-bold border-4 shadow-xl ${idx === 0 ? 'bg-gradient-to-r from-yellow-400 to-orange-500 text-black border-white scale-110 z-10' : 'bg-white/90 text-blue-900 border-blue-300'}`}>
                                            <div className="flex gap-8 items-center"><span className={`w-20 h-20 flex items-center justify-center rounded-full text-4xl border-2 ${idx===0 ? 'bg-white text-yellow-600 border-yellow-600' : 'bg-blue-100 text-blue-600 border-blue-600'}`}>{idx+1}</span><span>{p.name}</span></div><div className="font-mono text-6xl">{p.score}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {gameState.step === 'end' && (
                            <div className="animate-pop w-full max-w-6xl flex flex-col items-center">
                                <h1 className="text-8xl font-black title-gold mb-8">ğŸ† æœ€çµ‚æ¦®è­½æ¦œ ğŸ†</h1>
                                
                                <div className="flex justify-center mb-8 w-full">
                                    <div className="bg-gradient-to-b from-yellow-300 to-yellow-600 p-2 rounded-[3rem] shadow-2xl transform scale-110 z-20">
                                        <div className="bg-red-700 rounded-[2.5rem] p-10 text-center border-4 border-yellow-200 min-w-[500px]">
                                            <div className="text-[7rem] mb-4 drop-shadow-lg">ğŸ‘‘</div>
                                            <div className="text-7xl font-black text-white mb-4 text-shadow-strong">{players[0]?.name}</div>
                                            <div className="text-6xl font-mono text-yellow-200 font-bold">{players[0]?.score}</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-center gap-12 mb-10 w-full px-8">
                                    {players.slice(1, 3).map((p, idx) => (
                                        <div key={p.id} className={`flex-1 p-8 rounded-3xl text-center border-4 shadow-xl relative top-0 ${idx===0 ? 'bg-gray-200 border-gray-400' : 'bg-orange-200 border-orange-400'}`}>
                                            <div className="text-6xl mb-4">{idx===0 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}</div>
                                            <div className="text-5xl font-bold text-slate-800 mb-2">{p.name}</div>
                                            <div className="text-5xl font-mono font-bold text-slate-900">{p.score}</div>
                                        </div>
                                    ))}
                                </div>

                                <div className="grid grid-cols-3 gap-6 w-full px-4">
                                    {players.slice(3, 6).map((p, idx) => (
                                        <div key={p.id} className="bg-white/95 p-6 rounded-2xl flex flex-col items-center justify-center border-4 border-blue-400 shadow-md">
                                            <div className="text-4xl font-bold text-slate-400 mb-2">#{idx+4}</div>
                                            <div className="text-4xl font-bold text-blue-900 truncate w-full text-center">{p.name}</div>
                                            <div className="text-3xl font-mono text-blue-600 mt-2">{p.score}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Host æ§åˆ¶åˆ— */}
                    {gameState.step !== 'lobby' && gameState.step !== 'end' && (
                        <div className="p-8 bg-blue-900/90 flex justify-center gap-8 border-t-4 border-yellow-400 shadow-2xl">
                            {gameState.step === 'question' && <button onClick={() => hostAction('reveal')} disabled={isProcessing} className={`bg-yellow-500 hover:bg-yellow-400 text-black px-16 py-6 rounded-2xl font-bold text-4xl shadow-lg btn-push border-4 border-white ${isProcessing ? 'btn-disabled' : ''}`}>å¼·åˆ¶å…¬ä½ˆ</button>}
                            {gameState.step === 'reveal' && <button onClick={() => hostAction('leaderboard')} disabled={isProcessing} className={`bg-blue-500 hover:bg-blue-400 text-white px-16 py-6 rounded-2xl font-bold text-4xl shadow-lg btn-push border-4 border-blue-200 ${isProcessing ? 'btn-disabled' : ''}`}>çœ‹æ’è¡Œ</button>}
                            {gameState.step === 'leaderboard' && <button onClick={() => hostAction('nextQ')} disabled={isProcessing} className={`bg-green-600 hover:bg-green-500 text-white px-16 py-6 rounded-2xl font-bold text-4xl shadow-lg btn-push border-4 border-green-200 ${isProcessing ? 'btn-disabled' : ''}`}>ä¸‹ä¸€é¡Œ âœ</button>}
                        </div>
                    )}
                </div>
                );
            }

            // 3. Player
            if (view === 'player') {
                const myRank = players.findIndex(p => p.id === myPlayer.uid) + 1;
                return (
                <div className="min-h-screen flex flex-col p-4 bg-slate-900">
                    <div className="flex justify-between items-center mb-4 bg-white p-4 rounded-2xl shadow-lg border-4 border-blue-500">
                        <div className="font-black text-4xl truncate max-w-[160px] text-blue-900">{myPlayer.name}</div> 
                        <div className="flex gap-2">
                            {myRank > 0 && <div className="bg-red-600 text-white px-3 py-2 rounded-xl font-mono font-bold text-2xl border-2 border-red-800">#{myRank}</div>}
                            <div className="bg-yellow-400 px-3 py-2 rounded-xl font-mono font-bold text-black text-2xl border-2 border-yellow-600">{myPlayer.score}</div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col justify-center text-center">
                        {gameState.step === 'lobby' && (
                            <div className="animate-pulse flex flex-col items-center">
                                <div className="text-9xl mb-8">â³</div>
                                <h2 className="text-6xl font-black mb-4 text-white">é€£ç·šæˆåŠŸï¼</h2>
                                <p className="text-blue-200 text-3xl">è«‹çœ‹å¤§è¢å¹•ï¼Œç­‰å¾…é–‹å§‹...</p>
                            </div>
                        )}
                        
                        {gameState.step === 'question' && gameState.qIndex !== myPlayer.lastQ && (
                            <div className="grid-btn-container">
                                {['A', 'B', 'C', 'D'].map((label, idx) => (
                                    <button key={idx} onClick={() => playerAnswer(idx)} className={`rounded-3xl text-9xl font-black text-white shadow-xl btn-push flex items-center justify-center border-b-[16px] active:border-b-0 active:translate-y-4 transition-all ${['bg-red-600 border-red-900', 'bg-blue-600 border-blue-900', 'bg-yellow-500 border-yellow-800', 'bg-green-600 border-green-900'][idx]}`}>
                                        {label}
                                    </button>
                                ))}
                            </div>
                        )}

                        {gameState.step === 'question' && gameState.qIndex === myPlayer.lastQ && (
                            <div className="animate-pop">
                                <div className="text-9xl mb-8 animate-bounce">ğŸš€</div>
                                <h2 className="text-6xl font-black text-green-400 mb-4">ç­”æ¡ˆå·²é€å‡º</h2>
                                <p className="text-white text-4xl">è«‹çœ‹å¤§è¢å¹•çµæœ</p>
                            </div>
                        )}

                        {(gameState.step === 'reveal' || gameState.step === 'leaderboard') && (
                            <div className="bg-white p-10 rounded-3xl shadow-2xl border-8 border-blue-500">
                                <h2 className="text-6xl font-black mb-6 text-blue-900">æœ¬é¡ŒçµæŸ</h2>
                                <p className="text-gray-600 text-4xl font-bold">æ­£ç¢ºç­”æ¡ˆè«‹çœ‹å¤§è¢å¹•</p>
                            </div>
                        )}

                        {gameState.step === 'end' && (
                            <div className="animate-pop">
                                <h2 className="text-6xl font-black mb-8 text-white">æœ€çµ‚å¾—åˆ†</h2>
                                <div className="text-[7rem] font-mono font-black text-yellow-400 mb-8">{myPlayer.score}</div>
                                <div className="text-blue-200 text-4xl">æ„Ÿè¬åƒèˆ‡ï¼</div>
                            </div>
                        )}
                    </div>
                </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
